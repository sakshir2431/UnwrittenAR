<!DOCTYPE html>
<html>
  <head>
    <meta
      name="viewport"
      content="width=device-width,initial-scale=1,user-scalable=no"
    />
    <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
    <style>
      html,
      body {
        margin: 0;
        height: 100%;
        overflow: hidden;
        background: #000;
        color: #fff;
        font: 14px system-ui;
      }
      .hint {
        position: absolute;
        top: 12px;
        left: 50%;
        transform: translateX(-50%);
        padding: 8px 12px;
        border-radius: 999px;
        background: rgba(255, 255, 255, 0.08);
        z-index: 2;
      }
      .tap {
        position: absolute;
        bottom: 12px;
        left: 50%;
        transform: translateX(-50%);
        padding: 8px 12px;
        border-radius: 999px;
        background: rgba(255, 255, 255, 0.08);
        z-index: 2;
      }
    </style>
  </head>
  <body>
    <div class="hint">Tap to place Â· Double-tap to reset</div>
    <div class="tap">Immersive AR</div>

    <a-scene
      xr-mode-ui="enabled: true"
      renderer="colorManagement: true; physicallyCorrectLights: true;"
      webxr="optionalFeatures: hit-test, dom-overlay; overlayElement: body;"
      vr-mode-ui="enabled: false"
      embedded
    >
      <a-entity light="type: ambient; intensity: 0.9"></a-entity>
      <a-entity
        light="type: directional; intensity: 0.8"
        position="0 1 0"
      ></a-entity>
      <a-camera position="0 1.6 0"></a-camera>
      <a-entity id="root"></a-entity>
    </a-scene>

    <script>
      const root = document.getElementById("root");
      let current;

      function clearRoot() {
        while (root.firstChild) root.removeChild(root.firstChild);
        current = null;
      }

      function placeAt(position) {
        if (!current) return;
        current.setAttribute(
          "position",
          `${position.x} ${Math.max(0.02, position.y)} ${position.z}`
        );
      }

      function spawnExperience(exp, center) {
        clearRoot();
        const wrap = document.createElement("a-entity");
        wrap.setAttribute(
          "position",
          `${center.x} ${Math.max(0.02, center.y)} ${center.z}`
        );

        // Base ring
        const base = document.createElement("a-ring");
        base.setAttribute("radius-inner", "0.18");
        base.setAttribute("radius-outer", "0.22");
        base.setAttribute("rotation", "-90 0 0");
        base.setAttribute("position", "0 0.01 0");
        base.setAttribute(
          "material",
          "color: #cfd3de; opacity: 0.25; transparent: true"
        );
        wrap.appendChild(base);

        if (exp && exp.videoUrl) {
          // Immersive video sphere
          const vid = document.createElement("a-videosphere");
          vid.setAttribute("src", exp.videoUrl);
          vid.setAttribute("rotation", "0 180 0");
          vid.setAttribute("loop", "true");
          vid.setAttribute("autoplay", "true");
          wrap.appendChild(vid);
        } else if (exp && exp.glbUrl) {
          // GLB model with optional animation and audio
          const e = document.createElement("a-entity");
          e.setAttribute("gltf-model", exp.glbUrl);
          e.setAttribute("position", "0 0.2 0");
          e.setAttribute("scale", exp.scale || "1 1 1");
          e.setAttribute("animation-mixer", "loop: repeat");
          e.setAttribute(
            "animation__spin",
            "property: rotation; to: 0 360 0; loop: true; dur: 24000; easing: linear"
          );
          wrap.appendChild(e);

          if (exp.audioUrl) {
            const s = document.createElement("a-entity");
            s.setAttribute(
              "sound",
              `src: url(${exp.audioUrl}); autoplay: true; loop: true; positional: true; distanceModel: linear; refDistance: 0.6; rolloffFactor: 1.8; maxDistance: 10`
            );
            s.setAttribute("position", "0 0.2 0");
            wrap.appendChild(s);
          }

          if (exp.title) {
            const t = document.createElement("a-entity");
            t.setAttribute("text", {
              value: exp.title,
              align: "center",
              color: "#f3f4f6",
              width: 2.2,
              shader: "msdf",
            });
            t.setAttribute("position", "0 0.7 0");
            wrap.appendChild(t);
          }
        }

        root.appendChild(wrap);
        current = wrap;
      }

      // Basic tap-to-place at 0.9m forward from camera
      function forwardOffset(distance) {
        const cam = document.querySelector("a-camera").object3D;
        const dir = new THREE.Vector3(0, 0, -1).applyQuaternion(cam.quaternion);
        const pos = cam.position.clone().add(dir.multiplyScalar(distance));
        return pos;
      }

      document.body.addEventListener("click", () => {
        const pos = forwardOffset(0.9);
        placeAt(pos);
      });

      document.body.addEventListener("dblclick", () => {
        const pos = forwardOffset(0.9);
        if (current) placeAt(pos);
      });

      // Receive selected experience from parent
      window.addEventListener("message", (ev) => {
        if (ev?.data?.type === "experience") {
          const exp = ev.data.payload || {};
          const pos = forwardOffset(0.9);
          spawnExperience(exp, pos);
        }
      });
    </script>
  </body>
</html>
